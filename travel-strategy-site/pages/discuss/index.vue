<template>
    <div class="discuss-container">
      <div class="publish">
        <button @click="addPost()">发布</button>
      </div>
      <div v-if="postList.length != 0" class="post-list">
        <div class="card" v-for="item in postList" :key="item.id" @click="goToPostDetail(item.id)">
          <div class="card-info">
            <div class="card-user-info">
              <img class="card-avatar" v-lazy="imgPref + item.avatarUrl">
              <div class="card-name">{{ item.nickName }}</div>
            </div>
            <div class="head-title">
              <h3>{{ item.title }}</h3>
            </div>
          </div>
          <div class="card-content">
            <img v-lazy="imgPref + item.coverImg">
            <p>{{ item.content }}</p>
          </div>
          <ul class="card-social">
            <li @click.stop class="card-social__item">
              <svg v-show="!item.isPraise"  @click="handleLike(item.id)" t="1676958887288" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="906" width="200" height="200">
                <path d="M698.4 212c46.2 0 89.8 18.2 122.5 51.2 68.1 68.6 68.1 180.2 0 248.7L531 804c-6.5 6.6-13.9 8-19 8.00000001s-12.4-1.4-19-8.00000001L203.1 511.9c-68.1-68.6-68.1-180.2 0-248.7 32.8-33 76.3-51.2 122.5-51.2s89.8 18.2 122.5 51.2l63.9 64.3 63.9-64.3c32.7-32.99999999 76.3-51.2 122.5-51.2m0-90c-67.5 0-134.9 25.9-186.4 77.79999999-51.5-51.89999999-118.9-77.8-186.4-77.79999999s-134.9 25.9-186.4 77.8c-102.9 103.69999999-102.9 271.8 0 375.6l289.9 292.1C452 890.5 482 902 512 902c30.00000001 0 60-11.49999999 82.8-34.6l289.9-292.1c102.9-103.69999999 102.9-271.8 0-375.6-51.4-51.8-118.8-77.7-186.3-77.7z" fill="#2c2c2c" p-id="907"></path>
              </svg>
              <svg v-show="item.isPraise" @click="handleLike(item.id)" t="1677310682609" :class="'hearthBtn'" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="967" width="200" height="200">
                <path d="M960.4 374.1c0 67.3-25.8 134.4-76.9 185.8L544 899.3c-17.7 17.7-46.4 17.7-64.1 0L140.5 559.8C38 457.2 38 291 140.5 188.3c51.3-51.1 118.4-76.9 185.8-76.9 55.7 0 111.3 17.7 157.9 52.7 16.6 12.5 39 12.5 55.6 0 103-77.5 249.9-69.5 343.7 24.1 51.1 51.5 76.9 118.5 76.9 185.9z" p-id="968" fill="#d81e06"></path>
              </svg>
              <span>{{ item.praiseNum }}</span>
            </li>
            <li class="card-social__item">
              <svg t="1676958907232" class="icon" viewBox="0 0 1171 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1060" width="200" height="200">
                <path d="M821.510124 787.499968H660.432094c-5.365949 0-8.93956 1.792337-12.524235 5.377012l-89.49517 89.484107c-41.157378 41.168442-109.166627 41.168442-152.127407 0l-89.49517-89.484107a16.208484 16.208484 0 0 0-12.535299-5.377012H143.187847C64.435638 787.499968 0 723.075394 0 644.323184v-501.190656C0 64.435638 64.435638 0 143.187847 0h680.114614c78.75221 0 143.187847 64.435638 143.187847 143.176783v501.190657c-1.792337 78.75221-66.227975 143.176783-144.935929 143.176783z m0-71.58286a71.804136 71.804136 0 0 0 71.593923-71.593924v-501.190656a71.793072 71.793072 0 0 0-71.593923-71.58286H141.39551a71.782008 71.782008 0 0 0-71.58286 71.58286v501.190656a71.793072 71.793072 0 0 0 71.58286 71.616051h161.07803c23.234004 0 46.545455 8.93956 62.6433 26.840807l89.49517 89.49517c14.316572 14.316572 35.79143 14.316572 50.108002 0l89.49517-89.49517c16.108909-16.131037 39.376105-26.840806 62.643301-26.840807zM266.637855 340.057307c30.425481 0 53.692677 23.234004 53.692676 53.703741v35.791429c0 30.425481-23.234004 53.692677-53.692676 53.692677s-53.692677-23.234004-53.692677-53.692677V393.761048c0-30.436545 23.234004-53.703741 53.692677-53.703741z m214.770706 0c30.425481 0 53.692677 23.234004 53.692677 53.703741v35.791429c0 30.425481-23.234004 53.692677-53.692677 53.692677s-53.692677-23.234004-53.692676-53.692677V393.761048c0-30.436545 23.234004-53.703741 53.692676-53.703741z m214.781771 0c30.425481 0 53.692677 23.234004 53.692677 53.703741v35.791429c0 30.425481-23.234004 53.692677-53.692677 53.692677s-53.692677-23.234004-53.692677-53.692677V393.761048c0-30.436545 23.234004-53.703741 53.692677-53.703741z m0 0" fill="#2c2c2c" p-id="1061"></path>
              </svg>
              <span>{{ item.commentsNum }}</span>
            </li>
            <li class="card-social__item">
              <svg t="1676958926901" class="icon" viewBox="0 0 1633 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1260" width="200" height="200">
                <path d="M816.586922 0C307.036683 0 0 519.349282 0 519.349282s356.031898 503.017544 816.586922 503.017544 816.586922-503.017544 816.586922-503.017544S1326.137161 0 816.586922 0z m524.248804 710.430622c-169.85008 143.719298-349.499203 233.54386-530.7815 233.54386s-360.931419-84.92504-530.781499-233.54386C220.478469 658.169059 163.317384 604.274322 114.322169 545.480064c-9.799043-9.799043-16.331738-21.23126-26.130781-31.030303 4.899522-9.799043 16.331738-21.23126 21.23126-31.030303 42.46252-58.794258 94.724083-115.955343 153.518341-169.85008C429.524721 164.950558 609.173844 73.492823 811.6874 73.492823S1193.85008 163.317384 1357.167464 311.936204c58.794258 52.261563 106.1563 111.055821 153.518341 169.85008 4.899522 9.799043 16.331738 21.23126 21.23126 31.030303-4.899522 9.799043-16.331738 21.23126-26.130781 31.030303-47.362041 55.527911-101.256778 114.322169-164.950558 166.583732z" p-id="1261" fill="#2c2c2c"></path><path d="M811.6874 200.880383c-158.417863 0-280.905901 127.38756-280.905901 280.905901 0 158.417863 127.38756 280.905901 280.905901 280.905901 158.417863 0 280.905901-127.38756 280.905901-280.905901s-127.38756-280.905901-280.905901-280.905901z m0 488.318979c-111.055821 0-200.880383-89.824561-200.880382-200.880383 0-111.055821 89.824561-200.880383 200.880382-200.880383S1012.567783 377.263158 1012.567783 488.318979c0 106.1563-89.824561 200.880383-200.880383 200.880383z" p-id="1262" fill="#2c2c2c"></path>
              </svg>
              <span>{{ item.readingNum }}</span>
            </li>
            <li class="card-social__item">
              <svg t="1677310115330" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="937" width="200" height="200">
                <path d="M512 864c194.4 0 352-157.6 352-352S706.4 160 512 160 160 317.6 160 512s157.6 352 352 352z m0 64C282.24 928 96 741.76 96 512S282.24 96 512 96s416 186.24 416 416-186.24 416-416 416z" fill="#515151" p-id="938"></path><path d="M512 544h192a32 32 0 0 1 0 64h-224a32 32 0 0 1-32-32V288a32 32 0 0 1 64 0v256z" fill="#515151" p-id="939"></path>
              </svg>
              <span>{{ item.createTime }}</span>
            </li>
          </ul>
        </div>
      </div>
      <p class="data-load load" v-if="postList.length != 0 && total > 6 && !noMore" @click="getData()">加载更多</p>
      <p class="data-load end" v-if="postList.length != 0 && noMore">没有更多了</p>
      <el-backtop target=".page-component__scroll .el-scrollbar__wrap"></el-backtop>
      <div v-show="postList.length == 0" class="noData">
        <div> 请打开麦克风交流 ~ ~ </div>
        <svg t="1678004832159" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="12382" width="400" height="400">
          <path d="M613.403927 610.639127c0.186182-20.303127 10.575127-36.575418 23.263418-36.426472 12.6976 0.148945 22.9376 16.653964 22.9376 36.95709 0 20.312436-10.24 36.817455-22.9376 36.957091-12.688291 0.148945-23.077236-16.123345-23.263418-36.426472v-1.061237zM358.344145 610.639127c0.186182-20.303127 10.575127-36.575418 23.263419-36.426472 12.688291 0.148945 22.928291 16.653964 22.928291 36.95709 0 20.312436-10.24 36.817455-22.928291 36.957091-12.688291 0.148945-23.077236-16.123345-23.263419-36.426472v-1.061237z" fill="#707070" p-id="12383"></path><path d="M232.401455 717.1072l0.037236-0.027927c2.848582 4.561455 8.247855 7.428655 14.075345 7.428654 8.545745 0 15.266909-7.000436 15.266909-15.620654 0-3.044073-0.837818-5.883345-2.290036-8.285091a0.074473 0.074473 0 0 1 0.037236-0.018618 275.930764 275.930764 0 0 1-30.850327-127.115637c0-153.069382 124.537018-277.6064 277.6064-277.6064 77.954327 0 148.498618 32.293236 198.972509 84.210037 48.64 50.027055 78.6432 118.281309 78.6432 193.396363 0 42.449455-9.579055 82.701964-26.679854 118.718837a14.708364 14.708364 0 0 0-2.057309 7.447272c0 8.648145 7.791709 15.657891 16.290909 15.657891 5.520291 0 10.426182-2.811345 13.181672-7.140072l0.065164 0.027927 0.363055-0.744727c0.316509-0.567855 0.605091-1.163636 0.847127-1.768728a307.460655 307.460655 0 0 0 29.696-132.189091c0-7.261091-0.251345-14.466327-0.744727-21.6064v-351.790545l64.726109 56.264145a15.481018 15.481018 0 0 0 20.303127-23.356509l-89.153164-77.498182a15.341382 15.341382 0 0 0-8.629527-3.714327 15.481018 15.481018 0 0 0-18.208582 15.238982v270.1312c-50.4832-102.372073-155.964509-172.962909-277.615709-172.962909-170.561164 0-309.313164 138.752-309.313163 309.313164a307.553745 307.553745 0 0 0 35.4304 143.611345zM972.967564 766.529164c-20.48-21.885673-49.496436-5.641309-72.117528 2.960291-11.990109 4.570764-18.953309 3.258182-29.844945-3.435055-11.990109-7.363491-22.844509-15.4624-37.301527-16.9984-15.024873-1.601164-28.597527 4.468364-41.071709 12.232145-16.235055 10.118982-33.447564 13.917091-51.851637 6.116073-14.019491-5.9392-25.748945-16.141964-40.969309-19.223273-16.681891-3.3792-32.069818 4.151855-45.307345 13.5168-13.386473 9.476655-22.704873 10.3424-37.524946 2.783419-15.695127-7.996509-32.237382-15.5648-50.334254-11.450182-16.430545 3.732945-30.375564 13.935709-46.610619 18.199273-17.8176 4.673164-34.620509-8.825018-49.65469-15.98371-14.038109-6.683927-29.947345-8.471273-44.571928-2.671709-14.373236 5.697164-25.693091 18.990545-41.639563 20.331055-19.074327 1.601164-34.871855-10.733382-51.879564-16.747055-17.566255-6.199855-34.061964-2.438982-50.194618 5.995055-8.992582 4.701091-17.892073 12.613818-28.755782 11.133673-10.724073-1.461527-18.264436-10.705455-27.871418-14.885237-26.763636-11.654982-45.381818 7.801018-68.961746 16.086109-16.207127 5.687855-36.566109-13.730909-50.9952-19.1488-21.243345-7.9872-41.081018-1.368436-55.119127 16.114037-12.9024 16.067491 9.793164 30.989964 22.825891 14.754909 7.968582-9.923491 13.498182-12.539345 25.181091-7.037673 12.343855 5.808873 23.458909 13.405091 36.445091 17.929309 14.093964 4.924509 28.085527 1.796655 41.276509-4.002909 12.921018-5.678545 26.279564-19.968 40.578327-10.826473 13.284073 8.4992 24.203636 14.820073 40.5504 15.378619 16.616727 0.577164 30.785164-10.258618 44.739491-17.556946 15.993018-8.368873 31.110982 4.431127 45.754182 10.109673 18.320291 7.112145 39.0144 9.755927 57.641891 2.4576 12.436945-4.877964 22.351127-15.322764 35.048727-19.111564 14.494255-4.328727 34.5088 13.256145 47.569455 18.162037 15.4624 5.808873 32.432873 5.483055 47.960436 0.418909 17.147345-5.594764 32.181527-19.567709 50.9952-14.326691 15.266909 4.244945 27.0336 15.629964 43.603782 16.607418 16.616727 0.977455 29.686691-5.436509 42.886982-14.773527 5.613382-3.974982 11.422255-7.791709 18.497163-8.117528 6.302255-0.279273 13.181673 5.157236 18.283055 8.164073 16.458473 9.709382 33.307927 15.750982 52.5312 16.067491 11.8784 0.195491 22.602473-2.615855 33.3824-7.2704 8.899491-3.844655 16.197818-10.724073 25.302109-14.168436 15.127273-5.715782 28.951273 9.700073 41.350982 16.114036 16.598109 8.582982 32.637673 7.447273 49.608145 0.986764 8.070982-3.072 15.909236-6.693236 24.082618-9.5232 3.099927-1.070545 6.395345-2.057309 9.672146-2.317964 4.058764-0.316509 1.833891-0.6144 3.9936 1.694255 14.2336 15.2576 37.022255 0.446836 22.816582-14.736291zM848.849455 846.373236c-10.091055 3.770182-15.946473 2.690327-25.115928-2.839272-10.091055-6.088145-19.223273-12.772073-31.390254-14.047419-12.641745-1.321891-24.064 3.695709-34.555346 10.109673-13.665745 8.359564-28.150691 11.496727-43.631709 5.054837-11.794618-4.9152-21.671564-13.339927-34.471563-15.88131-14.038109-2.792727-26.987055 3.425745-38.120728 11.17091-11.264 7.828945-19.102255 8.536436-31.576436 2.299345-13.2096-6.600145-27.136-12.855855-42.356364-9.458036-13.824 3.090618-25.553455 11.515345-39.228509 15.034181-14.996945 3.863273-29.137455-7.289018-41.7792-13.20029-11.813236-5.520291-25.199709-7.000436-37.515636-2.206255-12.092509 4.7104-21.615709 15.685818-35.039418 16.7936-16.048873 1.321891-29.342255-8.862255-43.659637-13.833309-14.773527-5.12-28.662691-2.020073-42.235345 4.952436-7.568291 3.8912-15.062109 10.416873-24.194327 9.197382-9.020509-1.210182-15.369309-8.843636-23.45891-12.297309-22.518691-9.6256-38.1952 6.441891-58.032872 13.284073-13.637818 4.701091-30.766545-11.347782-42.9056-15.816146-17.873455-6.600145-34.573964-1.135709-46.3872 13.302691-10.8544 13.274764 8.238545 26.893964 19.213963 13.479564 6.711855-8.201309 11.357091-10.361018 21.187491-5.818182 10.388945 4.803491 19.744582 11.068509 30.664146 14.810764 11.859782 4.068073 23.635782 1.480145 34.732218-3.304728 10.873018-4.691782 22.1184-16.495709 34.145745-8.946036 11.180218 7.019055 20.368291 12.241455 34.127128 12.706909 13.982255 0.474764 25.897891-8.471273 37.645963-14.503564 13.460945-6.916655 26.186473 3.658473 38.5024 8.350255 15.415855 5.883345 32.833164 8.061673 48.509673 2.029382 10.463418-4.030836 18.804364-12.651055 29.4912-15.788218 12.194909-3.574691 29.044364 10.947491 40.029091 15.006254 13.014109 4.803491 27.284945 4.533527 40.364218 0.344437 14.429091-4.617309 27.080145-16.160582 42.914909-11.841164 12.846545 3.509527 22.742109 12.911709 36.696437 13.7216 13.991564 0.809891 24.9856-4.486982 36.082036-12.204218 4.719709-3.2768 9.616291-6.441891 15.5648-6.702546 5.296873-0.232727 11.096436 4.263564 15.387927 6.749091 13.851927 8.015127 28.029673 13.014109 44.208873 13.274764 9.988655 0.158255 19.018473-2.169018 28.094836-6.013673 7.493818-3.1744 13.628509-8.862255 21.289891-11.701527 12.725527-4.729018 24.361891 8.015127 34.797382 13.312 13.963636 7.084218 27.461818 6.153309 41.741964 0.809891 6.786327-2.541382 13.386473-5.5296 20.256581-7.866182 2.615855-0.884364 5.380655-1.703564 8.136146-1.908364 3.416436-0.260655 1.545309-0.502691 3.360582 1.396364 11.999418 12.585891 31.166836-0.930909 19.213963-13.479564-17.249745-18.068945-41.6768-4.654545-60.704581 2.466909zM113.691927 314.544873c1.591855-0.484073 15.499636-4.319418 20.712728 7.512436 0.186182 1.536 0.512 3.127855 0.996072 4.775564a6.116073 6.116073 0 0 0 7.596218 4.105309 6.050909 6.050909 0 0 0 4.161164-7.512437c-3.807418-12.865164 9.914182-18.450618 11.515346-19.055709a6.032291 6.032291 0 0 0 3.602618-7.763781 6.144 6.144 0 0 0-7.866182-3.584c-5.231709 1.908364-12.632436 6.488436-16.886691 13.71229-8.946036-6.693236-20.8896-5.8368-27.536291-3.732945a6.032291 6.032291 0 0 0-3.965673 7.5776 6.153309 6.153309 0 0 0 7.670691 3.965673zM205.0048 251.885382c2.103855-0.642327 20.433455-5.753018 27.303564 10.016582 0.251345 2.048 0.670255 4.170473 1.321891 6.367418a8.070982 8.070982 0 1 0 15.499636-4.524218c-5.0176-17.156655 13.079273-24.603927 15.183127-25.404509a8.070982 8.070982 0 0 0-5.622691-15.136582c-6.888727 2.541382-16.653964 8.657455-22.258036 18.273745-11.785309-8.918109-27.536291-7.7824-36.296146-4.980363a8.070982 8.070982 0 1 0 4.868655 15.387927z" fill="#707070" p-id="12384"></path>
        </svg>
      </div>
      <div class="add-post">
        <el-dialog title="用脚丈量世界，用心记录生活！" :before-close="handleClose" :visible.sync="dialogTableVisible">
          <form class="add-form" @submit.prevent="submitBtn()">
            <ul>
              <li class="post-title">
                <div class="wave-group">
                  <input required="" type="text" class="input" v-model="postObj.title">
                  <span class="bar"></span>
                  <label class="label">
                    <span class="label-char" style="--index: 0">标</span>
                    <span class="label-char" style="--index: 1">题</span>
                  </label>
                </div>
              </li>
              <li>
                <span>封面图片</span>
                <el-upload required="" class="avatar-uploader" action="http://localhost/images/upload" :show-file-list="false" 
                :on-success="handleAvatarSuccess" :before-upload="coverImgUploadBefore" ref="coverimg">
                  <img v-if="coverImg" :src="coverImg" class="avatar">
                  <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                </el-upload>
              </li>
              <li class="form-content">
                <span>游记文章</span>
                <el-input required="" type="textarea" :autosize="{ minRows: 2, maxRows: 4}" 
                placeholder="请输入文章内容" v-model="postObj.content">
                </el-input>
              </li>
              <li class="post-img-url">
                <span>文章图片</span>
                <el-upload required="" action="http://localhost/images/upload" :limit="6" list-type="picture-card" 
                :on-success="uploadPostImgSuccess" :on-remove="handleRemove" :before-upload="postImgsUploadBefore" ref="postimgs" >
                  <i class="el-icon-plus"></i>
                </el-upload>
                <el-dialog :visible.sync="dialogVisible">
                  <img width="100%" :src="dialogImageUrl" alt="">
                </el-dialog>
              </li>
              <li class="btn-submit">
                <!-- <input type="submit" value="提交"> -->
                <button >
                  <span>提交</span>
                </button>
              </li>
            </ul>
          </form>
        </el-dialog>
      </div>
    </div>
</template>

<script>
import { getToken } from '@/utils/auth'
import { formatTime } from '@/utils/index'
import fileApi from '@/api/file'

import discussApi from '@/api/discuss'

import '~/assets/css/discuss.css'
export default {
  data() {
    return {
      imgPref: 'http://localhost:8888/images/download?fileName=',  // 图片访问前缀
      orignPostList: [],  // 源数据
      postList: [],
      isPraise: false,  // 是否点赞
      lastPage: false,  // 是否为最后一页
      current: 3, // 当前页码数
      limit: 3, // 每页记录数
      total: 0, // 总记录数
      dialogTableVisible: false,  // 写游记对话框显示状态
      coverImg: '', // 封面图片
      dialogImageUrl: '', // 游记图片地址
      dialogVisible: false, // 游记图片可视状态
      postObj: {
        postImgs: [], // 游记图片
      },  // 游记内容
      isCommit: false,
      token: null,  
    }
  },
  created() {
    var token = getToken()
    if(token != null) {
      this.token = token
    }

    this.init()
  },
  computed: {
    // 没有数据
    noMore () {
      return this.lastPage
    },
  },
  methods: {
    // 发布游记
    submitBtn () {
      this.postObj.userId = this.token.id
      this.postObj.nickName = this.token.nickName
      this.postObj.avatarUrl = this.token.avatarUrl

      if(this.coverImg == '' || this.postObj.postImgs.length == 0) {
        this.$message({
          message: '封面图片文章图片不能为空',
          type: 'warning'
        });
      } else {
        this.postObj.postImgs = this.postObj.postImgs.join(',')

        discussApi.addPost(this.postObj).then(res => {
          // 初始化数据
          this.postObj = {
            postImgs: []
          }
          this.coverImg = ''
  
          // 刷新页面
          this.$router.go(0)

          this.$message({
            type: 'success',
            message: '游记发布成功！'
          });
        })
      }
    },
    // 删除图片
    handleRemove(file) {
      if(file.response) {
        fileApi.deleteImage(file.response.data).then()

        for(var i = 0; i < this.postObj.postImgs.length; i++) {
          if(file.response.data == this.postObj.postImgs[i]) {
            this.$delete(this.postObj.postImgs, i)
            break
          }
        }
      }
    },
    // 游记图片上传成功的回调
    uploadPostImgSuccess(res) {
      this.postObj.postImgs.push(res.data)
    },
    // 限制游记图片上传格式
    postImgsUploadBefore (file) {
      if (file) {
        const suffix = file.name.split('.')[1]

        if(['png','jpeg','jpg'].indexOf(suffix) < 0){
          this.$message.error('上传图片只支持 png、jpeg、jpg 格式！')
          return false
        }
        return true
      }
    },
    // 图片上传成功的回调
    handleAvatarSuccess(res, file) {
      this.coverImg = URL.createObjectURL(file.raw);

      if(this.postObj.coverImg && this.postObj.coverImg != res.data) {
        fileApi.deleteImage(this.postObj.coverImg).then()
      }

      this.postObj.coverImg = res.data;
    },
    // 限制封面图上传格式
    coverImgUploadBefore(file) {
      const isJPG = file.type === 'image/jpeg';

      if (!isJPG) {
        this.$message.error('上传头像图片只能是 JPG 格式!');
      }
      return isJPG;
    },
    // 进入游记详情
    goToPostDetail(id) {
      window.location.href = '/discuss/detail/' + id
    },
    // 点赞操作
    handleLike(postId) {
      if(this.token == null) {
        window.location.href = '/login'
      } else {
        discussApi.changeLike(this.token.id, postId, this.orignPostList).then(res => {
          this.postList = res.data
          this.orignPostList = res.data
        })
      }
    },
    // 对话框关闭回调
    handleClose(done) {
        this.$confirm('确认关闭？')
          .then(_ => {
            done();
            if(this.postObj.coverImg != null) {
              this.postObj.postImgs.push(this.postObj.coverImg)
            }

            if(this.postObj.postImgs.length != 0) {
              fileApi.deleteAll(this.postObj.postImgs).then() 
            }

            this.$nextTick (() => {
              this.$refs.postimgs.clearFiles()
            })

            this.postObj = {
              postImgs: []
            }
            this.coverImg = ''
          })
          .catch(_ => {});
    },
    // 显示写游记对话框
    addPost() {
      if (this.token == null) {
        window.location.href = '/login'
      } else {
        this.dialogTableVisible = true
      }
    },
    // 加载数据
    pushData(userId, current, limit) {
      discussApi.getPostPage(userId, current, limit).then(res => {
        if (this.total > 6) {
          var records = res.data.records
  
          for(var i = 0; i < records.length; i++) {
            this.postList.push(records[i])
            this.orignPostList.push(records[i])

          }
  
          if(records.length < this.limit) {
            this.lastPage = true
          } else {
            this.currentPage += 1
          }
        } else {
          this.orignPostList = res.data.records
          this.postList = res.data.records
          this.total = res.data.total
        }

        // 格式化时间 出错：在这之前输出也是格式化过的
        // for(var i = 0; i < this.postList.length; i++) {
        //   this.postList[i].createTime = formatTime(new Date(this.postList[i].createTime))
        // }
      })
    },
    // 登录判断
    loginJudge(current, limit) {
      if(this.token != null) {
        this.pushData(this.token.id, current, limit)
      } else {
        this.pushData(-1, current, limit)
      }
    },
    // 滚动加载数据
    getData() {
      this.loginJudge(this.current, this.limit)
    },
    // 数据初始化
    init() {
      this.loginJudge(1,6)
    },
  },
  beforeDestroy() {
    // console.log('页面销毁前')
    // console.log('表单是否提交：' + this.isCommit)
  },
}
</script>