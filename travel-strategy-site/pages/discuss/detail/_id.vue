<template>
  <div class="discuss-detail-container">
    <!-- 顶部按钮行 -->
    <div class="top-btn">
      <!-- 返回按钮 -->
      <button class="goback-discuss-btn" @click="toGoback()">
        <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1024 1024">
          <path d="M874.690416 495.52477c0 11.2973-9.168824 20.466124-20.466124 20.466124l-604.773963 0 188.083679 188.083679c7.992021 7.992021 7.992021 20.947078 0 28.939099-4.001127 3.990894-9.240455 5.996574-14.46955 5.996574-5.239328 0-10.478655-1.995447-14.479783-5.996574l-223.00912-223.00912c-3.837398-3.837398-5.996574-9.046027-5.996574-14.46955 0-5.433756 2.159176-10.632151 5.996574-14.46955l223.019353-223.029586c7.992021-7.992021 20.957311-7.992021 28.949332 0 7.992021 8.002254 7.992021 20.957311 0 28.949332l-188.073446 188.073446 604.753497 0C865.521592 475.058646 874.690416 484.217237 874.690416 495.52477z"></path>
        </svg>
        <span>返回</span>
      </button>
      <!-- 删除按钮 -->
      <button v-if="token != null && token.id == post.userId" class="delete-post-btn" @click="deletePost(post.id)">
        <span class="text">删除文章</span>
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"></path>
          </svg>
        </span>
      </button>
    </div>
    <!-- 帖子信息 -->
    <div class="post-detail">
      <!-- 帖子头部信息 -->
      <div class="detail-header">
        <!-- 用户信息 -->
        <div class="user-info">
            <img class="user-avatar" :src="imgPref + post.avatarUrl">
            <div class="user-name">{{ post.nickName }}</div>
        </div>
        <div class="detail-title">
          <h2>{{ post.title }}</h2>
        </div>
        <div class="release-time">{{ post.createTime }}</div>
      </div>
      <!-- 帖子内容 -->
      <div class="detail-content">
          <pre>{{ post.content }}</pre>
          <div class="content-imgs-info">
            <div class="content-img" v-show="post.postImgs.length != 0" v-for="(item,index) in post.postImgs" :key="index">
              <img v-lazy="imgPref + item">
            </div>
          </div>
      </div>
      <!-- 评论区 -->
      <div class="user-comments">
        <div class="comments-input-unlogin" v-show="token == null">
          <div>请先登录才能评论</div>
          <button @click="gotoLogin()">登录
            <div class="arrow-wrapper">
                <div class="arrow"></div>
            </div>
          </button>
        </div>
        <div v-show="token != null" class="comments-input">
          <input placeholder="随心而吐，畅所欲言！" type="text" @focus="handleCommentFocus()" v-model="postComment.content">
          <button @click="sendComment()">发布</button>
        </div>
        <ul v-if="postComments != null && postComments.length != 0" class="comments-list">
          <li :class="isReply && replyId == item.id?'liReply':'noReply'" v-for="(item, index) in postComments" :key="index">
            <div class="item-user">
              <div class="user-info">
                <img class="user-avatar" v-lazy="imgPref + item.avatarUrl">
                <div class="user-name">{{ item.nickName }}</div>
                <span v-show="item.userId == post.userId" class="author-sign">作者</span>
                <div v-show="item.parentId > 0">回复：{{ item.parentUserName }}</div>
                <div v-show="item.parentId < 0" class="comment-deleted"> * 回复的评论已删除 * </div>
              </div>
              <div v-if="token != null && token.id == item.userId" class="delete-my-comment">
                <button @click="removeComment(item)">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" height="25" width="25">
                    <path fill="#6361D9" d="M8.78842 5.03866C8.86656 4.96052 8.97254 4.91663 9.08305 4.91663H11.4164C11.5269 4.91663 11.6329 4.96052 11.711 5.03866C11.7892 5.11681 11.833 5.22279 11.833 5.33329V5.74939H8.66638V5.33329C8.66638 5.22279 8.71028 5.11681 8.78842 5.03866ZM7.16638 5.74939V5.33329C7.16638 4.82496 7.36832 4.33745 7.72776 3.978C8.08721 3.61856 8.57472 3.41663 9.08305 3.41663H11.4164C11.9247 3.41663 12.4122 3.61856 12.7717 3.978C13.1311 4.33745 13.333 4.82496 13.333 5.33329V5.74939H15.5C15.9142 5.74939 16.25 6.08518 16.25 6.49939C16.25 6.9136 15.9142 7.24939 15.5 7.24939H15.0105L14.2492 14.7095C14.2382 15.2023 14.0377 15.6726 13.6883 16.0219C13.3289 16.3814 12.8414 16.5833 12.333 16.5833H8.16638C7.65805 16.5833 7.17054 16.3814 6.81109 16.0219C6.46176 15.6726 6.2612 15.2023 6.25019 14.7095L5.48896 7.24939H5C4.58579 7.24939 4.25 6.9136 4.25 6.49939C4.25 6.08518 4.58579 5.74939 5 5.74939H6.16667H7.16638ZM7.91638 7.24996H12.583H13.5026L12.7536 14.5905C12.751 14.6158 12.7497 14.6412 12.7497 14.6666C12.7497 14.7771 12.7058 14.8831 12.6277 14.9613C12.5495 15.0394 12.4436 15.0833 12.333 15.0833H8.16638C8.05588 15.0833 7.94989 15.0394 7.87175 14.9613C7.79361 14.8831 7.74972 14.7771 7.74972 14.6666C7.74972 14.6412 7.74842 14.6158 7.74584 14.5905L6.99681 7.24996H7.91638Z" clip-rule="evenodd" fill-rule="evenodd"></path>
                  </svg>
                  <span >delete</span>
                </button>
              </div>
            </div>
            <div class="comment-info">
              <p>{{ item.content }}</p>
              <div class="comment-bottom">
                <div class="comment-time">{{ item.createTime }}</div>
                <div class="reply">
                  <button @click="replyComment(item.id)">回复</button>
                </div>
              </div>
            </div>
            <div v-show="isReply && replyId == item.id" class="comments-input">
              <input placeholder="随心而吐，畅所欲言！" type="text" v-model="replyContent">
              <button @click="sendComment()">发布</button>
            </div>
          </li>
          <el-pagination :current-page="current" :page-size="limit" :total="total" style="padding: 30px 0; text-align: center;"
            layout="total, prev, pager, next, jumper" @current-change="getData" />
        </ul>
        <div v-else class="post-detail-noData">
          <div>当前暂时没有评论哦！</div>
          <svg t="1677908726208" class="icon" viewBox="0 0 1196 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3297" width="300" height="300">
            <path d="M145.827003 355.766568c-10.052931-0.441997-18.890871 7.032952-19.553866 17.159883-0.662995 10.126931 6.996952 18.891871 17.159883 19.590866 1.767988 0.109999 11.379922 0.699995 26.32982 0.699995 61.203582 0 211.781552-9.831933 279.760087-101.747304 6.075958-8.174944 4.34497-19.701865-3.829974-25.739825-8.248944-6.076958-19.811865-4.309971-25.813823 3.865974-72.545504 98.175329-272.02714 86.35441-274.052127 86.169411zM1034.22993 392.517317c10.126931-0.699995 17.786878-9.426936 17.160883-19.589866-0.699995-10.163931-8.616941-17.713879-19.590866-17.160883-2.061986 0.183999-201.432623 12.004918-273.941128-86.170411-6.075958-8.211944-17.639879-9.905932-25.740824-3.866974-8.211944 6.039959-9.942932 17.56588-3.866973 25.739825 67.905536 91.953371 218.519506 101.749304 279.723088 101.749304 14.839899 0 24.488833-0.589996 26.25582-0.699995zM469.297792 802.343515h254.939257c10.163931 0 18.412874-8.249944 18.412874-18.412874V470.476784c0-10.163931-8.248944-18.412874-18.412874-18.412874h-254.938257c-10.164931 0-18.413874 8.248944-18.413874 18.412874v313.453857c0 10.163931 8.212944 18.412874 18.412874 18.412874z m18.412874-313.454857H705.825175v276.630109H487.710666V488.888658zM876.21401 189.574704V56.525614l76.08048 133.04909h38.408738V5.045966h-36.014754v129.549114L880.63298 5.045966h-40.433724v184.528738h18.080877zM1172.876982 26.587818C1156.931091 8.874939 1135.315239 0 1108.027426 0c-27.065815 0-48.645667 8.83794-64.627559 26.587818-15.981891 17.675879-23.972836 41.611716-23.972836 71.73451 0 29.533798 8.027945 52.954638 23.972836 70.26252 15.981891 17.344881 37.561743 25.998822 64.627559 25.998822 27.287813 0 48.903666-8.653941 64.849556-25.998822 15.981891-17.307882 23.899837-40.728722 23.899837-70.26252 0.036-30.122794-7.917946-54.021631-23.899837-71.73451z m-27.876809 118.355191c-8.874939 11.268923-21.174855 16.902884-36.935748 16.902885-15.723893 0-28.023808-5.633961-36.861748-16.902885-8.76394-11.267923-13.21991-26.881816-13.219909-46.84168 0-20.47386 4.45597-36.419751 13.293909-47.982672 8.874939-11.525921 21.136856-17.344881 36.787748-17.344881 15.760892 0 28.059808 5.78196 36.935748 17.344881 8.83794 11.525921 13.293909 27.508812 13.293909 47.982672 0 19.959864-4.45597 35.609757-13.293909 46.84168z" p-id="3298" fill="#707070"></path><path d="M1150.524135 236.268385c-10.163931 0-18.412874 8.249944-18.412874 18.412874v529.249382c0 20.143862-15.871892 36.64075-35.719756 37.671743-1.39999-3.902973-3.387977-7.732947-5.744961-11.451922-0.073999-0.147999-0.183999-0.257998-0.257998-0.368998-1.619989-2.503983-3.239978-5.080965-5.339963-7.474949-0.772995-0.883994-1.766988-1.693988-2.576983-2.540982-0.257998-0.294998-0.589996-0.589996-0.846994-0.846994-2.614982-2.687982-5.560962-5.265964-8.76494-7.695948-0.993993-0.773995-2.024986-1.50999-3.055979-2.283984-2.540983-1.766988-5.302964-3.387977-8.138944-5.007966-1.214992-0.699995-2.282984-1.50999-3.571976-2.209985-0.404997-0.219998-0.846994-0.329998-1.251991-0.514996-5.339963-2.650982-11.194923-4.970966-17.380882-7.033952-2.209985-0.735995-4.41997-1.39899-6.739954-2.061986-6.259957-1.766988-12.740913-3.276978-19.663865-4.38197-2.245985-0.330998-4.565969-0.478997-6.849953-0.772995-5.743961-0.699995-11.63592-1.104992-17.749879-1.289991-2.687982-0.109999-5.338964-0.256998-8.063945-0.256998-7.696947 0.073999-15.613893 0.589996-23.789837 1.43599a295.50798 295.50798 0 0 0-9.315937 1.251991 250.752286 250.752286 0 0 0-22.609845 4.308971c-3.277978 0.772995-6.555955 1.619989-9.869933 2.539983-7.401949 2.025986-14.876898 4.41997-22.462846 7.18195a335.253708 335.253708 0 0 0-10.495928 3.939973c-9.058938 3.719975-18.264875 7.879946-27.544812 12.667914-2.650982 1.39999-5.339963 2.98298-8.027945 4.455969A355.42357 355.42357 0 0 0 817.994408 820.460391c-0.625996 0.442997-1.214992 0.699995-1.839987 1.105993H409.898198c-1.214992-0.809994-2.393984-1.362991-3.571976-2.172985a367.11149 367.11149 0 0 0-28.575804-17.307882c-1.693988-0.883994-3.351977-1.914987-5.045966-2.761981-10.420929-5.449963-20.731858-10.089931-30.895789-14.139903-1.914987-0.773995-3.792974-1.43699-5.670961-2.136986-20.695859-7.732947-40.691722-12.740913-59.656592-15.318895-2.098986-0.294998-4.160972-0.625996-6.222957-0.846994-8.72794-0.956993-17.234882-1.50999-25.446827-1.50999-2.355984-0.037-4.602969 0.109999-6.885952 0.183999-6.443956 0.183999-12.741913 0.662995-18.779872 1.36299-2.099986 0.293998-4.309971 0.404997-6.371957 0.735995-6.922953 1.104992-13.403908 2.651982-19.627865 4.41997-2.319984 0.661995-4.565969 1.287991-6.774954 2.061986-6.149958 2.061986-12.004918 4.34497-17.344881 7.032952-0.367997 0.183999-0.809994 0.294998-1.177992 0.478997-1.252991 0.662995-2.246985 1.43599-3.424977 2.135985-2.90998 1.619989-5.670961 3.276978-8.285943 5.081965a112.769229 112.769229 0 0 0-3.092979 2.319985 78.97646 78.97646 0 0 0-8.616941 7.548948c-0.331998 0.367997-0.736995 0.699995-1.067993 1.030993-0.773995 0.846994-1.730988 1.619989-2.467983 2.466983-2.061986 2.393984-3.681975 4.934966-5.301964 7.438949-0.073999 0.146999-0.220998 0.294998-0.294998 0.441997-2.356984 3.755974-4.34497 7.549948-5.744961 11.489922h-54.979624c-20.805858 0-37.708742-16.939884-37.708742-37.746742V82.156438c0-20.769858 16.902884-37.671742 37.709742-37.671742H754.064845c10.163931 0 18.411874-8.248944 18.411874-18.412874S764.229776 7.659948 754.065845 7.659948H74.53349C33.436771 7.659948 0 41.096719 0 82.156438v701.775203c0 41.132719 33.436771 74.56949 74.53349 74.56949h55.016624c3.461976 10.27493 9.574935 20.47486 18.706873 29.939796a18.98987 18.98987 0 0 0 8.65394 5.080965c92.13637 23.825837 115.005214 53.359635 120.418177 68.862529 5.965959 16.976884-3.902973 30.638791-4.529969 31.449785-6.149958 7.952946-4.786967 19.405867 3.129979 25.665825 7.954946 6.333957 19.554866 4.934966 25.888823-2.98298 8.469942-10.715927 20.253862-36.52975 10.568928-65.400553-13.21991-39.365731-60.614586-70.26252-140.856038-91.841372-6.443956-7.733947-8.359943-14.103904-8.359942-19.185869 0.038-5.155965 2.725981-10.31093 7.328949-15.135896 2.393984-2.503983 5.375963-4.859967 8.83794-7.069952 1.251991-0.809994 2.466983-1.656989 3.866974-2.429983 2.87198-1.583989 6.406956-2.87298 9.868932-4.198972 2.650982-1.066993 5.118965-2.282984 7.989946-3.165978 13.552907-4.013973 30.123794-6.223957 48.978665-5.560962 1.913987 0.073999 4.012973 0.367997 6.001959 0.514996 7.438949 0.479997 15.134897 1.325991 23.162841 2.725982 3.239978 0.588996 6.591955 1.361991 9.905933 2.098985 7.29195 1.582989 14.729899 3.607975 22.389847 6.038959 3.571976 1.140992 7.179951 2.319984 10.789926 3.681975 8.469942 3.129979 17.159883 6.923953 25.960822 11.194923 2.725981 1.289991 5.449963 2.429983 8.175944 3.829974 11.893919 6.259957 23.972836 13.404908 36.198753 21.98485 134.448081 94.382355 119.97618 141.997029 120.123179 141.997029-4.749968 8.984939-1.288991 20.142862 7.695947 24.89383a18.387874 18.387874 0 0 0 8.579942 2.135986c6.629955 0 12.999911-3.571976 16.313888-9.832933 5.559962-10.567928 24.119835-63.522566-86.796407-155.216939h308.887889c-110.916242 91.694373-92.393368 144.649011-86.796407 155.216939 3.387977 6.370956 10.053931 10.20093 16.902885 10.20093 2.798981 0 5.597962-0.625996 8.248943-2.024986 8.984939-4.749968 12.667913-15.356895 7.916946-24.341834-0.146999-0.478997-15.576894-48.129671 119.681182-143.065022 11.820919-8.322943 23.531839-15.134897 35.020761-21.247854 4.050972-2.135985 8.101945-3.829974 12.115917-5.744961 7.401949-3.497976 14.766899-6.775954 21.98385-9.463936a305.189914 305.189914 0 0 1 13.07291-4.455969c6.923953-2.172985 13.735906-4.013973 20.401861-5.486963 3.718975-0.809994 7.474949-1.729988 11.119924-2.356983 7.807947-1.324991 15.282896-2.209985 22.537846-2.650982 2.098986-0.109999 4.271971-0.478997 6.333956-0.551997 18.853871-0.625996 35.462758 1.545989 48.976666 5.559962 2.799981 0.846994 5.192965 2.025986 7.733947 3.01998 3.571976 1.39999 7.179951 2.724981 10.12693 4.34497 1.361991 0.773995 2.576982 1.583989 3.829974 2.356984 3.460976 2.245985 6.479956 4.602969 8.83794 7.106951 4.602969 4.860967 7.29095 10.016932 7.32795 15.209896v0.036c0 5.118965-1.951987 11.415922-8.359943 19.11187-80.278451 21.579852-127.635127 52.475641-140.819038 91.841372-9.720934 28.834803 2.099986 54.685626 10.569928 65.401553 6.332957 7.953946 17.932877 9.316936 25.849824 2.982979 7.991945-6.296957 9.317936-17.859878 2.983979-25.850823-0.109999-0.147999-10.27493-13.662907-4.529969-30.859789 5.265964-15.576894 27.876809-45.257691 120.529176-69.304526a18.189876 18.189876 0 0 0 8.652941-5.081966c9.206937-9.574935 15.355895-19.811865 18.817871-30.159793 40.102726-1.104992 72.434505-33.952768 72.434505-74.386492V254.681259c0-10.19993-8.248944-18.411874-18.411874-18.411874z" p-id="3299" fill="#707070"></path><path d="M423.598104 243.413336c8.76394 0 17.60188-0.736995 26.034822-2.282984 9.979932-1.840987 16.644886-11.415922 14.840899-21.432854-1.840987-9.979932-11.378922-16.754885-21.431854-14.765899-23.309841 4.270971-48.609668 0-59.583592-6.591955-8.76394-5.229964-20.069863-2.429983-25.298827 6.296957-5.228964 8.72794-2.392984 20.032863 6.333956 25.261827 14.435901 8.689941 36.60475 13.514908 59.104596 13.514908zM730.608006 212.774545c-9.979932-2.245985-19.811865 3.866974-22.131849 13.699907-2.319984 9.904932 3.792974 19.810865 13.699906 22.167848 5.522962 1.325991 11.819919 1.951987 18.521874 1.951987 20.769858 0 45.626688-6.112958 66.027548-16.755886 8.984939-4.712968 12.483915-15.833892 7.769947-24.85683-4.749968-9.021938-15.907891-12.482915-24.89383-7.769946-20.989857 11.010925-46.435683 14.5829-58.993596 11.56292z" p-id="3300" fill="#707070"></path>
          </svg>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { getToken } from '@/utils/auth'
import { formatTime } from '@/utils/index'
import discussApi from '@/api/discuss'
import browseRecordApi from '@/api/browseRecord'

import '~/assets/css/discussDetail.css'
export default {
  async asyncData({params, error}) {
    return discussApi.getPost(params.id).then(res => {
      return {
        post: res.data,  // 帖子详情
      }
    })
  },
  data() {
    return {
      postId: 0,  // 帖子id
      postComments: [], // 评论列表
      current: 1, // 当前页码数
      limit: 5, // 每页记录数
      total: 0, // 总评论数
      imgPref: 'http://localhost:8888/images/download?fileName=',  // 图片访问前缀
      postComment: {
        content: '',  // 评论内容
      },  // 评论
      isReply: false, // 是否回复
      replyId: 0, // 回复的评论id
      replyContent: '', // 回复的评论
      token: null,
    }
  },
  created() {
    var token = getToken()
    if (token != null) {
      this.token = token
    }

    this.postId = this.$route.params.id

    this.init()
  },
  methods: {
    // 回复评论
    replyComment(id) {
      if(this.token != null) {
        if(this.replyId == id) {
          this.isReply = !this.isReply
        } else {
          this.isReply = true
        }
        this.replyId = id
      } else {
        window.location.href = '/login'
      }
    },
    // 删除评论
    removeComment(postComment) {
      this.$confirm('此操作将永久删除该评论, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        discussApi.deleteComment(postComment).then(res => {
          this.getData()

          this.$message({
            type: 'success',
            message: '删除成功!'
          });
        })
      }).catch(() => {
        this.$message({
          type: 'info',
          message: '已取消删除'
        });          
      });
    },
    // 发送评论
    sendComment() {
      if(!this.isReply) {
        this.postComment.parentId = 0
      } else {
        this.postComment.content = this.replyContent
        this.postComment.parentId = this.replyId
      }

      discussApi.addComment(this.postComment).then(res => {
        this.postComment.content = ''
        this.replyContent = ''

        this.getData()
      })
    },
    // 发布评论失焦监听
    handleCommentFocus() {
      this.isReply = false
      this.replyContent = ''
      this.replyId = 0
    },
    // 删除帖子
    deletePost(id) {
      this.$confirm('此操作将永久删除该文章, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        discussApi.removePost(id).then(res => {
          this.$message({
            type: 'success',
            message: '删除成功!'
          });
          
          this.toGoback()
        })
      }).catch(() => {
        this.$message({
          type: 'info',
          message: '已取消删除'
        });          
      });
    },
    // 跳转到登录页
    gotoLogin() {
      window.location.href = '/login'
    },
    getData(page = 1) {
      this.current = page
      discussApi.getPostComment(this.postId, this.current, this.limit).then(res => {
        this.postComments = res.data.records
        this.total = res.data.total

        // for(var i = 0; i < this.postComments.length; i++) {
        //   this.postComments[i].createTime = formatTime(new Date(this.postComments[i].createTime))
        // }
      })
    },
    // 初始化数据
    init() {
      this.post.postImgs = this.post.postImgs.split(',')

      this.getData()

      if(null != this.token) {
        this.postComment.userId = this.token.id
        this.postComment.postId = this.postId
        this.postComment.nickName = this.token.nickName
        this.postComment.avatarUrl = this.token.avatarUrl

        browseRecordApi.userBrowseRecord(this.token.id, this.postId, 'POST').then()
      }
    },
    // 返回讨论页
    toGoback() {
      window.location.href = '/discuss'
    },
  }
}
</script>